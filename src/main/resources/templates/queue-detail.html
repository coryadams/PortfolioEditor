<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: header"/>
<body class="page-body" data-url="http://neon.dev">
<div class="page-container">
    <!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->

    <div th:include="fragments/sidebar-menu :: sidebar" th:remove="tag"/>

    <div class="main-content">

        <div class="row">
            <!-- Raw Links -->
            <ul class="list-inline links-list pull-right">
                <li class="sep"></li>
                <li>
                    <div th:include="fragments/logout-links :: link" th:remove="tag"/>
                </li>
            </ul>
            <div th:inline="text">Logged in User: [[${#httpServletRequest.remoteUser}]]</div>
        </div>

        <hr/>
        <br/>


        <h3 th:text="|Queue Name: ${queueName} |"/>

        <div class="row">
            <div class="col-sm-3">
                <div class="tile-stats tile-red">
                    <div class="icon"><i class="entypo-users"></i></div>
                    <div class="num" data-start="0" th:attr="data-end=*{totalConnections}" data-postfix=""
                         data-duration="1500" data-delay="0">0
                    </div>
                    <h3>Total Connections</h3>

                    <p></p>
                </div>
            </div>
            <div class="col-sm-3">
                <div class="tile-stats tile-green">
                    <div class="icon"><i class="entypo-database"></i></div>
                    <div class="num" data-start="0" th:attr="data-end=*{queueDepth}" data-postfix=""
                         data-duration="1500" data-delay="600">0
                    </div>
                    <h3>Queue Depth</h3>

                    <p></p>
                </div>
            </div>
            <div class="col-sm-3">
                <div class="tile-stats tile-aqua">
                    <div class="icon"><i class="entypo-chat"></i></div>
                    <div class="num" data-start="0" th:attr="data-end=*{messagesIn}" data-postfix=""
                         data-duration="1500" data-delay="1200">0
                    </div>
                    <h3>Messages In</h3>

                    <p></p>
                </div>
            </div>
            <div class="col-sm-3">
                <div class="tile-stats tile-blue">
                    <div class="icon"><i class="entypo-rss"></i></div>
                    <div class="num" data-start="0" th:attr="data-end=*{messagesOut}" data-postfix=""
                         data-duration="1500" data-delay="1800">0
                    </div>
                    <h3>Messages Out</h3>

                    <p></p>
                </div>
            </div>
        </div>

        <br/>

        <div class="row">
            <div class="col-sm-8">
                <div class="panel panel-primary" id="charts_env">
                    <div class="panel-heading">
                        <div class="panel-title">Message Latency for Queue
                            <th:block th:text="${queueName}"/>
                        </div>
                        <div class="panel-options">
                            <!--<ul class="nav nav-tabs">-->
                            <!--<li class="active"><a href="#line-chart" data-toggle="tab">Line Charts</a></li>-->
                            <!--</ul>-->
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="tab-content">
                            <div class="tab-pane active" id="line-chart-latency">
                                <div id="line-chart-demo" class="morrischart" style="height: 300px" ></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <br/>

        <div class="row">
        </div>
        <!-- Footer -->
        <footer th:replace="fragments/footer :: footer"/>
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    jQuery(document).ready(function ($) {

        $.ajax({
            url: [[${statsServerBaseAddress}]] + '/api/query?=start=2015/01/11-00:00:00&end=2015/01/11-00:25:00&msResolution=true&m=sum:queue.messageLatency&jsonp=localJsonpCallback',
            jsonpCallback: "localJsonpCallback",
            // Tell jQuery we're expecting JSONP
            dataType: "jsonp",
            error: function() {
                alert("An error occoured!");
            },
            // Work with the response
            success: function( response ) {
                localJsonpCallback(response);
            }
        });

        function localJsonpCallback(json) {
            var dataAsString;
            for (var key in json) {
                var obj = json[key];
                for (var prop in obj) {
                    if(obj.hasOwnProperty(prop)){
                        if (prop === 'dps') {
                            var dpsObj = obj[prop];
                            var graphData = [];
                            Object.keys(dpsObj).forEach(function (key) {
                                var k = key;
                                k = (k * 1000); // Get to ms as msResolution tag is being ignored by openTSDB
                                var v = dpsObj[key];
                                graphData.push({
                                    x: k,
                                    y: v
                                });
                            });
                            dataAsString = graphData;
                        }
                    }
                }
            }

            // Line Charts
            var line_chart_demo = $("#line-chart-demo");
            var labelQueue = [[${queueName}]] + ' Avg Latency';
            var line_chart = Morris.Line({
                element: 'line-chart-demo',
                data: dataAsString,
                xkey: 'x',
                ykeys: ['y'],
                labels: [labelQueue],
                xLabels: '30sec',
                redraw: true
            });
        }
    });

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    /*]]>*/
</script>
<th:block th:include="fragments/index-footer-links :: links"/>
</body>
</html>